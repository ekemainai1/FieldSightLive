name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:
    inputs:
      run_emulator:
        description: 'Run Firestore emulator integration profile'
        required: false
        default: false
        type: boolean

jobs:
  test:
    name: Frontend + Backend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Run quality gates (lint, typecheck, build)
        run: npm run quality:ci

      - name: Run unified CI tests
        run: npm run test:ci

  test-emulator:
    name: Emulator Integration Profile
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_emulator == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: cloud-firestore-emulator

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Run quality gates (lint, typecheck, build)
        run: npm run quality:ci

      - name: Start Firestore emulator
        run: |
          gcloud emulators firestore start --host-port=127.0.0.1:8081 > /tmp/firestore-emulator.log 2>&1 &
          sleep 8

      - name: Run emulator-gated CI tests
        env:
          FIRESTORE_EMULATOR_HOST: 127.0.0.1:8081
          GOOGLE_CLOUD_PROJECT: fieldsightlive-test
        run: npm run test:ci:emulator
